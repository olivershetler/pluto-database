# Table Guide

This document is a guide to the tables in the final database that you will have if you run all the sql scripts in order.

## Tables with the name `pluto[year]`

These tables correspond directly to the raw data files. Records are unique up to BBL, so the field `bbl` can serve as the primary key.

## `building_features`

This table contains re-engineered building characteristics from the PLUTO data sets. For more details on the features, see the [article](./article.pdf). Its primary key is given by the pair (`bbl`, `year`).

**Note** that this table only contains a **subset** of all the records available from the raw PLUTO files. Namely, it contains only records for **residential** buildings. More particularly, the filter used when choosing records was

```{sql}
[...]
    WHERE (
        ( bldgclass LIKE ANY(ARRAY['D%','C%','S3','S4','S5']) )
            OR
        ( bldgclass LIKE 'S9' AND UnitsRes >= 3 )
          )
    AND UnitsTotal > 0
    AND numbldgs > 0
    AND yearbuilt > 0
```

## `zip_level_attributes`

The `zip_level_attributes` contains attributes of the zip code level. The primary key is given by the pair (`zip`, `year`). The `zip` field is the 5-digit zip code, and the `year` field is the year of the data set. You can find more details about the zip-level attributes in the [scripts guide](./guides/scripts.md)...

## `features_all`

The `features_all` table is generated by the script in `bbl-and-zip-level-features.sql`. It merges the `building_features` and `zip_level_attributes` tables. The primary key is given by the pair (`bbl`, `year`) (the redundancy is to ensure that there are no entries where `zipcode` and `bbl` are mis-matched).

## `pc_vpu`

The `pc_vpu` table contains `pcvpu` (percent change in total value per unit) values, along with the identifiers `bbl` and `year`. The `pcvpu` values are computed by

```{sql}
[...]
(CASE WHEN pluto[year].UnitsTotal > 0 AND pluto2021.assesstot > 0 AND pluto2020.UnitsTotal > 0 AND pluto2020.assesstot > 0 THEN
       ROUND(((pluto2021.assesstot/pluto2021.UnitsTotal) - (pluto2020.assesstot/pluto2020.UnitsTotal))/(pluto2020.assesstot/pluto2020.UnitsTotal), 6)
       ELSE NULL END)
[...]
```

The primary key is given by the pair (`bbl`, `year`).

## `pc_vpu_trunc`

This table is the same as the above table, except the filter

```{sql}
WHERE pcvpu < 3 AND pcvpu > -0.75;
```

is applied. This ensures that 3-fold changes are excluded, as they almost never occur unless a property is demolished or completely gut rennovated. In situations like this, pcvpu is no longer a proxy for rents because these rennovations require the building to be vacated.

## `pc_vpu_lagged`

The `pc_vpu_lagged` table is created by repeatedly inner joining the `pc_vpu_trunc` table with itself on (`bbl`, `year`), but with the `year`=`year`+L for L in the sequence (1,2,3).

## `block_distance`

The `block_distance` table is a table of pairs of `block` identifiers, along with the distance between each piar. The coordinates of each `block` are first computed by averaging the coordinates (`xcord` and `ycoord`) for residential buildings in each block. Then, the distances are computed using the euclidean norm.

The primary key for this table is the pair (`block1`, `block2`).

## `block_neighbors`

This table has a primary key called `block` which has the block identifier of each residential building in the data-set (taken from 2021). For each `block`, it also contains the block identifiers of the 4 nearest neigboring blocks (ranked using the distances computed in `block_distance`)

## `nearest_block_neighbors_avg_pcvpu`

The table `nearest_block_neighbors_avg_pcvpu` has the primary key (`block`, `year`). In addition to identifiers, it contains the average percent change in value per unit for each block and neighborhing blocks (average pcvpu is substituted for block ids in the `block_neighbors` table).

## VIEW `lagged_nearest_block_neighbors_avg_pcvp`

The view `lagged_nearest_block_neighbors_avg_pcvp` computes 3 years of lagged pcvpu values for each block and neighbor by means of self joins with displaced years (see [`pc_vpu_lagged`](#pc-vpu-lagged) for more details)

## `zip_pc_vpu` and `zip_pc_vpu_lagged`

`zip_pc_vpu` is a table with the primary key `zipcode` and `year`. It contains the average percent change in value per unit for residential buildings in each zipcode. The `zip_pc_vpu_lagged` contains a lagged version of the table, with the same primary key.

## `pc_vpu_all`

This table has the primary key (`bbl`, `year`). It joins all lagged bbl, block and zipcode level percent changes in value per unit computed in the other tables.

## `pluto`, `pluto_sym` and `pluto_disc`

The `pluto` table has the primary key (`bbl`, `year`). It joins `pc_vpu_all` and `building_features`. The `pluto_sym` table is identical to above, except that all the pcvpu variables are symmetrized. See `sql/pluto-04-2--panel-data-symmetrized.sql` for more details on the exact computation. `pluto_disc` is also the same as `pluto` except that `target_pcvpu` is discretized. See
`sql/pluto-04-3--discrete-panel-data.sql` for the exact computation.
